https://www.youtube.com/watch?v=5CkCr9U_Q1Y
Meet Renovate - Your Update Automation Bot for Kubernetes and More!
Сколько вы времени каждую неделю тратите на поиск обновленных изображений контейнеров для сервисов, запущенных в вашем кластере Kubernetes. Всего 5 минут, 5 часов, никогда?
Раньше я часами проверял наличие новых изображений контейнеров, читал об изменениях и не знал, действительно ли это так, собираюсь ли я разбить свой кластер или нет.
Делать это было очень утомительно до такой степени, что я почти перестал это делать. Именно тогда я открыл для себя программу Renovate bot от компании Mend.
Renovate – это средство автоматизации обновления зависимостей, которое сканирует ваше программное обеспечение, обнаруживает зависимости и проверяет – существует ли обновление.
И если таковые имеются, оно поможет вам в этом, автоматически отправив запрос на извлечение в вашу кодовую базу.
Он работает из коробки и поддерживает широкий спектр языков и технологий. Он легко настраивается и позволяет вам контролировать, что и когда будет обновляться. К тому же, он довольно умный и может автоматически обнаруживать зависимости и предлагать идеи по улучшению.
Он не только может сканировать все виды зависимостей, но и дает вам возможность самостоятельно выбирать, как вы хотите его запустить.
Хотите запустить его локально как узловой модуль или из командной строки? А, может быть, в контейнере Docker? Или даже самостоятельно разместить в своем кластере Kubernetes? Никаких проблем не возникнет. Хотите отсканировать зависимости с GitHub, Gitlab или других поставщиков Git? Никаких проблем не возникнет.
Одна из замечательных особенностей Renovate заключается в том, что благодаря открытому исходному коду, вы можете контролировать, как вы хотите его запускать и где вы хотите его запускать, и когда вы хотите его запустить.
Сегодня мы займемся настройками Renovate bot, который протянет нам руку помощи с ресурсами Kubernetes.
Мы создадим репозиторий на GitHub для размещения всех наших развертываний Kubernetes и добавим Renovate bot в наш репозиторий. А затем позволим ему помочь нам, открыв запросы на извлечение, когда он увидит обновления для любого из наших изображений контейнеров, которые мы используем.
У меня такое чувство, будто бы я бесплатно нанял инженера по DevOps.
Насколько высоко доступные сервисы запущены в вашем кластере Kubernetes? Настроены ли они в соответствии с лучшими практиками обеспечения безопасности? Была ли она закалена в соответствии с руководством Ан по закалке? Все эти вопросы вы могли бы задать себе, если бы работали под управлением Kubernetes.
Но как узнать, следуете ли вы этим рекомендациям? Именно в этом вам может помочь Datree.
Datree – это мощный инструмент управления политиками Kubernetes, который может защитить ваш кластер Kubernetes, блокируя конфигурации, которые не соответствуют вашей политики.
Я говорю «вашей политике», потому что это политика централизовано управляется вашей командой и может быть настроена в соответствии с вашими потребностями. Или вы можете унаследовать одно из множеств предварительно настроенных руководств по передовым практикам. Это работает путем создания веб-крючка для доступа, который гарантирует, что ничто не может быть развернуто в вашем кластере, если оно не соответствует настроенной вами политике.
А аще вы можете просмотреть и внести изменения в свою политику с помощью их информационной панели. Отсюда вы можете проанализировать все нарушения своей политики, просмотреть результаты последнего сканирования кластера, внести изменения в политику и даже посмотреть оценку состояния своего кластера. Вы даже можете запускать разные политики для разных кластеров и управлять одним кластером бесплатно. Так что обеспечьте безопасность своего Kubernetes, предотвратите неправильные настройки и уже сегодня установите дерево в своем кластере.
Программа Renovate работает со многими различными поставщиками систем управления версиями, такими как 
GitHub, GitLab, AWS CodeCommit и многими другими. У вас также есть выбор способа управления программой 
Renovate, т. е. вы можете самостоятельно разместить ее с помощью Docker, Kubernetes или запустить как бесплатное приложение GitHub.
Мы собираемся использовать GitHub и приложение GitHub, потому что оно очень простое в настройке.
Еще одно небольшое замечание: все это будет размещено на моем сайте.
1-го числа нам нужно будет создать репозиторий на GitHub. Это также просто, как зайти на GitHub и создать новый репозиторий.
После того как вы назовете свой репозиторий, вам нужно выбрать – делать ли его общедоступным или закрытым. Выбор остается за вами. И программа Renovate будет работать в любом случае.
После создания нового репозитория, вам захочется клонировать его на свою машину. Я знаю, что оно пустое. Но в ближайшее время мы сюда кое-что добавим. После того как я его клонирую, я собираюсь открыть его с помощью кода Versus, но подойдет любой редактор.
Теперь, наш репозиторий клонирован, мы собираемся добавить в него некоторые ресурсы Kubernetes, чтобы Renovate могла начать анализировать наши ресурсы на предмет обновления.
Мы собираемся создать простое развертывание Nginx и сервис. Для этого развертывания мы будем использовать более старый тег изображения контейнера Nginx, потому что хотим убедиться, что Renovate bot действительно работает.
Мы зайдем на сайт Docker Hub и выберем более старый тег. Затем мы включим этот тег изображения в наше развертывание.
Давайте зафиксируем этот код и продвинем его вверх.
Теперь, когда у нас есть простое развертывание Kubernetes, привязанное к нашему репозиторию, нам следует добавить бота для обновления, чтобы начать анализировать наш код.
Мы можем сделать это, зайдя на сайт GitHub, найдя приложение для обновления и установив его в наш репозиторий.
Вам нужно будет авторизовать это приложение для своего репозитория или для своей организации. Как только вы авторизовали это приложение, вы можете выбрать, к каким репозиториям оно имеет доступ и все готово.
Если вы когда-нибудь передумаете и решите удалить это приложение из своего репозитория, вы можете зайти в настройки репозитория и удалить это приложение в любое время.
Как только бот Renovate будет авторизован и установлен, он фактически ничего не будет делать, пока вы не 
объедините запрос на извлечение, который будет открыт боту на репозиторий.
Этот запрос на извлечение представляет собой специальный запрос на включение, который покажет вам, что на самом деле обнаружил бот, а также добавит конфигурацию по умолчанию для бота.
Renovate не будет вносить никаких дальнейших изменений до тех пор, пока вы не примите и не объедините этот запрос на извлечение данных.
Как только вы ознакомитесь с этим сообщением, вы сможете объединить его. И это активирует бота в вашем репозитории. После объединения этого сообщения о внедрении, мы сможем выйти и посмотреть логи бота на странице Mend бот.
Здесь мы видим, что он пытается автоматически определить все различные зависимости, которые поддерживает бот. Он проверяет наличие зависимостей Ansible, Docker Compose, Flux, Gradle и многих других зависимостей. Но он не знает, как обращаться с файлами Kubernetes из коробки, потому что файлы Kubernetes не имеют соглашения об именовании, потому что на самом деле такого не существует.
Нам нужно будет рассказать Renovate, как проверить наличие этих файлов в Kubernetes в нашей конфигурации. Нам нужно будет подключиться к интернету, чтобы получить самую свежую версию. И мы должны посмотреть наш конфигурационный файл обновления. Нам нужно будет добавить свойства сопоставления файлов для  файлов Kubernetes. Вы должны быть уверены, что используете здесь правильное расширение, будь то yml, либо yaml. И то, и другое приемлемо, но обычно я использую yml или yaml. Именно это я собираюсь использовать здесь.
Как только мы внесем это изменение в нашу конфигурацию локально, мы зафиксируем это изменение и продвинем его вверх. Как только мы внесем это изменение, оно просканирует репозиторий, мы увидим, что была создана новая проблема. Это просто потрясающе!
Это особый тип проблем, который создает для нас Renovate, и который является чем-то вроде информационной панели для наших зависимостей. Если мы посмотрим на эту проблему, то увидим, что она обнаружила новую зависимость, связанную с Kubernetes, и что обнаружила не только наш тег Nginx, но и наши версии api Kubernetes предназначены для этого развертывания. Это просто потрясающе.
Если хотите, вы можете отключить ту проблему с панелью мониторинга в своей конфигурации, но я бы рекомендовал сохранить ее. Это не повредит, а только поможет.
Если мы посмотрим на журналы обновления, мы также увидим, что оно обнаружило наше развертывание Nginx и создало для нас PR для ознакомления. Мы должны увидеть новый PR-ролик, который был открыт с помощью бота Renovate.
Если мы посмотрим на этот PR-ролик, то увидим предлагаемые изменения. В нем предлагается изменить изображение нашего контейнера Nginx с 1.24 на 1.25, что является последним текущим тегом.
Если нас устраивает это изменение, мы можем объединить его с нашим кодом всего лишь одним щелчком мыши. Это потрясающе. Так что теперь наша кодовая база обновлена до последней версии изображения контейнера.
Но что произойдет, если контейнер, который вы использовали, содержит только один тег, скажем, самый последний тег. Давайте сейчас это выясним.
Предположим, что мы запускаем WordPress в нашем кластере и создаем yaml для развертывания. А в нашем yaml 
для развертывания мы указываем тег последней версии по сравнению с тегом версии. Фиксируем этот код и продвигаем его вверх. Теперь мы можем дождаться обновления, чтобы еще раз проверить репозиторий на наличие новых зависимостей или же мы можем запустить его вручную, вернувшись к проблеме на панели мониторинга зависимостей и установив этот флажок, чтобы запустить его снова.
Если мы еще раз посмотрим на логи, то увидим, что он обнаружил WordPress, однако у него нет версий. Последний тег является недетерминированным, а это значит, что он не является детерминированным. Или, проще говоря, он может означать более, чем одну вещь.
Программа Renovate не может использовать эту функцию, потому что она не может определить какова текущая версия и какова следующая возможная версия.
Вместо того, чтобы привязывать эту версию к последней версии, мы действительно можем прикрепить ее Digest.
Посмотрим на наш текущий тег последней версии в Docker Hub и проверим Digest. Мы можем увидеть его здесь. Это вот такая длинная строка символов. Digest является неизменяемым идентификатором изображения контейнера или является детерминированным. А это означает, что он не может быть изменен и содержит только ссылки на одно изображение. Мы можем использовать его для обновления.
Как только он у нас появится, мы сможем прикрепить наш контейнер WordPress к Digest, используя его так.
Сначала нужно поместить изображение контейнера, а затем сам Digest. Если мы внесем это изменение, зафиксируем его и продвинем дальше, то получим доступ к Digest, который также совпадает с последней версией. Если мы хотим принудительно выполнить сканирование вместо того, чтобы ждать, мы можем вернуться к проблеме на панели мониторинга, установить флажок. И еще раз посмотрите на записи в журналах.
Теперь мы можем видеть, что он обнаружил наши изображения контейнера WordPress вместе с Digest. Теперь он может сравнить его с текущим Digest.
Откройте PR-канал, если в этом возникнет необходимость.
Если мы посмотрим на панель мониторинга проблемных зависимостей, то теперь видим, что она обнаружила WordPress, прикрепленный к Digest. Теперь мы не увидим PR, потому что этот Digest является последним Digest.
Однако, если WordPress выпустит новые изображения контейнера с новым Digest, мы получим запрос на вытягивание для замены Digest. У нас очень много Digests. Это просто потрясающе! Это решает последнюю проблему.
У нас есть способы работать с манифестами Kubernetes, независимо оттого, прикреплены ли они к тегу версии или тегу не версии.
А как насчет диаграмм управления? С диаграммами управления все также просто.
Предположим, что мы хотели бы управлять исходным кодом нашего развертывания MySQL Helm. Все, что нам нужно сделать, это создать наш файл значений Helm и включить в него версию, а также репозиторий.
Если вы не укажете репозиторий, по умолчанию он будет называться Docker Hub. Но как вы видите здесь, я получаю эту диаграмму управления от Bitnami. После того как мы зафиксируем и продвинем этот процесс вверх, мы должны увидеть новый тип управления зависимостями. А поскольку в нем обнаружено обновление, мы также должны увидеть запрос на опрос для обновления файла. Это просто потрясающе!
Так что с помощью обновленного бота мы можем отслеживать и обновлять наши развертывания в Kubernetes и даже схемы управления ими. И я уверен, что вам интересно, как мы можем их развернуть.
Существует довольно много способом развертывания этих ресурсов с помощью инструментов GitHub, таких как Flux или Argo CD, или даже простой задачи CI, которая выполняется под управлением KB Control или Helm.
У меня есть несколько видеороликов на эту тему, так что я не буду здесь углубляться в эту тему.
Я узнал массу нового о боте Renovate, о том, как добавить его в наш репозиторий Git и как автоматизировать запросы на извлечение при наличии доступных обновлений. И я надеюсь, что вы тоже кое-чему научились. 